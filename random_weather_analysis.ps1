# ================================================================
# üé≤ RANDOM LOCATION WEATHER ANALYSIS - FIXED VERSION
# Analiza provider√≥w w ca≈Çkowicie losowych lokalizacjach na ≈õwiecie
# Symuluje rzeczywiste warunki pracy validatora
# ================================================================

param(
    [int]$LocationCount = 20,
    [int]$MaxWorkers = 3,
    [switch]$IncludeOceans = $false,
    [switch]$CleanStart = $false
)

Write-Host "üé≤ RANDOM LOCATION WEATHER ANALYSIS" -ForegroundColor Green
Write-Host "===================================" -ForegroundColor Green
Write-Host "üåç Generating $LocationCount random locations worldwide" -ForegroundColor Cyan
Write-Host "‚öôÔ∏è Max parallel workers: $MaxWorkers" -ForegroundColor Cyan
Write-Host "üåä Include oceans: $IncludeOceans" -ForegroundColor Cyan

# Wyczy≈õƒá stare wyniki je≈õli wymagane
if ($CleanStart) {
    Write-Host "üßπ Cleaning old results..." -ForegroundColor Yellow
    Remove-Item central_weather_results.csv -ErrorAction SilentlyContinue
    Remove-Item dashboard\* -ErrorAction SilentlyContinue
}

# Funkcja generowania losowych koordinat
function Get-RandomCoordinates {
    param(
        [bool]$IncludeOceans = $false
    )

    $locations = @()
    $attempts = 0
    $maxAttempts = $LocationCount * 5  # 5x wiƒôcej pr√≥b ni≈º potrzeba

    # Obszary lƒÖdowe (przybli≈ºone bbox dla kontynent√≥w)
    $landAreas = @(
        # Europa
        @{MinLat=35; MaxLat=71; MinLon=-10; MaxLon=40; Name="Europe"},
        # Azja
        @{MinLat=10; MaxLat=70; MinLon=60; MaxLon=180; Name="Asia"},
        # Ameryka P√≥≈Çnocna
        @{MinLat=15; MaxLat=70; MinLon=-170; MaxLon=-50; Name="North_America"},
        # Ameryka Po≈Çudniowa
        @{MinLat=-55; MaxLat=15; MinLon=-85; MaxLon=-35; Name="South_America"},
        # Afryka
        @{MinLat=-35; MaxLat=37; MinLon=-20; MaxLon=52; Name="Africa"},
        # Australia
        @{MinLat=-45; MaxLat=-10; MinLon=110; MaxLon=160; Name="Australia"}
    )

    while ($locations.Count -lt $LocationCount -and $attempts -lt $maxAttempts) {
        $attempts++

        if ($IncludeOceans) {
            # Ca≈Çkowicie losowe (w≈ÇƒÖcznie z oceanami)
            $lat = (Get-Random -Minimum -90 -Maximum 90) + (Get-Random) * 0.0001
            $lon = (Get-Random -Minimum -180 -Maximum 180) + (Get-Random) * 0.0001
            $region = "Ocean_Random"
        } else {
            # Wybierz losowy obszar lƒÖdowy
            $area = $landAreas | Get-Random
            $lat = Get-Random -Minimum $area.MinLat -Maximum $area.MaxLat
            $lon = Get-Random -Minimum $area.MinLon -Maximum $area.MaxLon
            $region = $area.Name

            # Dodaj ma≈ÇƒÖ losowo≈õƒá dla precyzji
            $lat += (Get-Random) - 0.5
            $lon += (Get-Random) - 0.5

            # Ogranicz do prawid≈Çowych warto≈õci
            $lat = [Math]::Max(-90, [Math]::Min(90, $lat))
            $lon = [Math]::Max(-180, [Math]::Min(180, $lon))
        }

        # Unikaj duplikat√≥w (sprawd≈∫ odleg≈Ço≈õƒá > 1 stopie≈Ñ)
        $tooClose = $false
        foreach ($existing in $locations) {
            $distance = [Math]::Sqrt([Math]::Pow($lat - $existing.Lat, 2) + [Math]::Pow($lon - $existing.Lon, 2))
            if ($distance -lt 1.0) {
                $tooClose = $true
                break
            }
        }

        if (-not $tooClose) {
            $locationName = "Random_$($locations.Count + 1)_$($region.Replace(' ', ''))"
            $locations += @{
                Name = $locationName
                Lat = [Math]::Round($lat, 4)
                Lon = [Math]::Round($lon, 4)
                Region = $region
            }

            Write-Host "üìç Generated: $locationName ($($lat.ToString("F4")), $($lon.ToString("F4"))) in $region" -ForegroundColor White
        }
    }

    if ($locations.Count -lt $LocationCount) {
        Write-Host "‚ö†Ô∏è Generated only $($locations.Count) unique locations (attempted $attempts times)" -ForegroundColor Yellow
    }

    return $locations
}

# Funkcja analizy pojedynczej lokalizacji
function Invoke-LocationAnalysis {
    param(
        [hashtable]$Location,
        [int]$Index,
        [int]$Total
    )

    $name = $Location.Name
    $lat = $Location.Lat
    $lon = $Location.Lon
    $region = $Location.Region

    Write-Host "[$Index/$Total] üìç Analyzing $name ($region)..." -ForegroundColor Cyan

    try {
        # U≈ºyj kr√≥tszego okresu dla szybszej analizy
        $result = python consolidated_analysis.py --lat $lat --lon $lon --start 2025-08-02T00:00:00Z --end 2025-08-05T00:00:00Z --providers openmeteo,weatherapi,visualcrossing --location-name $name 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "  ‚úÖ Success: $name" -ForegroundColor Green
            return @{Status="Success"; Location=$name; Output=$result}
        } else {
            Write-Host "  ‚ùå Failed: $name (Exit code: $LASTEXITCODE)" -ForegroundColor Red
            return @{Status="Failed"; Location=$name; Error=$result}
        }
    } catch {
        Write-Host "  üí• Exception: $name - $($_.Exception.Message)" -ForegroundColor Red
        return @{Status="Exception"; Location=$name; Error=$_.Exception.Message}
    }
}

# Generuj losowe lokalizacje
Write-Host "`nüé≤ GENERATING RANDOM COORDINATES..." -ForegroundColor Cyan
$randomLocations = Get-RandomCoordinates -IncludeOceans:$IncludeOceans

Write-Host "`nüìä SUMMARY OF GENERATED LOCATIONS:" -ForegroundColor Yellow
$regionCounts = $randomLocations | Group-Object Region | Sort-Object Count -Descending
foreach ($regionGroup in $regionCounts) {
    Write-Host "  üåç $($regionGroup.Name): $($regionGroup.Count) locations" -ForegroundColor White
}

Write-Host "`nüöÄ STARTING ANALYSIS..." -ForegroundColor Green
Write-Host "=============================" -ForegroundColor Green

# Analiza lokalizacji (sekwencyjna lub r√≥wnoleg≈Ça)
$results = @()
$successful = 0
$failed = 0

if ($MaxWorkers -eq 1) {
    # Analiza sekwencyjna
    Write-Host "üìÑ Running sequential analysis..." -ForegroundColor Cyan
    for ($i = 0; $i -lt $randomLocations.Count; $i++) {
        $location = $randomLocations[$i]
        $result = Invoke-LocationAnalysis -Location $location -Index ($i + 1) -Total $randomLocations.Count
        $results += $result

        if ($result.Status -eq "Success") {
            $successful++
        } else {
            $failed++
        }

        # Kr√≥tka przerwa miƒôdzy analizami
        Start-Sleep -Seconds 2
    }
} else {
    # Analiza r√≥wnoleg≈Ça (uproszczona)
    Write-Host "‚ö° Running parallel analysis (simplified)..." -ForegroundColor Cyan

    # Podziel lokalizacje na batch-e
    $batchSize = [Math]::Min($MaxWorkers, $randomLocations.Count)
    $batches = @()

    for ($i = 0; $i -lt $randomLocations.Count; $i += $batchSize) {
        $end = [Math]::Min($i + $batchSize - 1, $randomLocations.Count - 1)
        $batches += ,$randomLocations[$i..$end]
    }

    foreach ($batch in $batches) {
        Write-Host "üì¶ Processing batch of $($batch.Count) locations..." -ForegroundColor Yellow

        foreach ($location in $batch) {
            $index = [Array]::IndexOf($randomLocations, $location) + 1
            $result = Invoke-LocationAnalysis -Location $location -Index $index -Total $randomLocations.Count
            $results += $result

            if ($result.Status -eq "Success") {
                $successful++
            } else {
                $failed++
            }
        }

        # Przerwa miƒôdzy batch-ami
        if ($batch -ne $batches[-1]) {
            Write-Host "‚è∏Ô∏è Batch complete, pausing..." -ForegroundColor Gray
            Start-Sleep -Seconds 5
        }
    }
}

# Podsumowanie wynik√≥w
Write-Host "`nüéâ ANALYSIS COMPLETE!" -ForegroundColor Green
Write-Host "===================" -ForegroundColor Green
Write-Host "üìä Results Summary:" -ForegroundColor Yellow

$successRate = if ($randomLocations.Count -gt 0) { [Math]::Round($successful/$randomLocations.Count*100, 1) } else { 0 }
$failRate = if ($randomLocations.Count -gt 0) { [Math]::Round($failed/$randomLocations.Count*100, 1) } else { 0 }

Write-Host "  ‚úÖ Successful: $successful/$($randomLocations.Count) ($successRate)" -ForegroundColor Green
Write-Host "  ‚ùå Failed: $failed/$($randomLocations.Count) ($failRate)" -ForegroundColor Red

# Szczeg√≥≈Çy niepowodze≈Ñ
$failedResults = $results | Where-Object { $_.Status -ne "Success" }
if ($failedResults.Count -gt 0) {
    Write-Host "`n‚ö†Ô∏è FAILED LOCATIONS:" -ForegroundColor Red
    foreach ($failure in $failedResults) {
        Write-Host "  ‚ùå $($failure.Location): $($failure.Status)" -ForegroundColor Red
    }
}

# Analiza geograficzna wynik√≥w
Write-Host "`nüåç GEOGRAPHICAL DISTRIBUTION OF RESULTS:" -ForegroundColor Cyan
$successByRegion = $results | Where-Object { $_.Status -eq "Success" } | ForEach-Object {
    $loc = $randomLocations | Where-Object { $_.Name -eq $_.Location }
    [PSCustomObject]@{Region = $loc.Region; Status = $_.Status}
} | Group-Object Region

foreach ($regionGroup in $successByRegion) {
    $regionTotal = ($randomLocations | Where-Object { $_.Region -eq $regionGroup.Name }).Count
    $regionSuccess = $regionGroup.Count
    $regionSuccessRate = if ($regionTotal -gt 0) { [Math]::Round($regionSuccess / $regionTotal * 100, 1) } else { 0 }
    Write-Host "  üåç $($regionGroup.Name): $regionSuccess/$regionTotal success ($regionSuccessRate%)" -ForegroundColor White
}

# Uruchom zaawansowanƒÖ analizƒô je≈õli mamy wyniki
if ($successful -gt 0) {
    Write-Host "`nüìà RUNNING ADVANCED ANALYSIS..." -ForegroundColor Cyan

    # Podstawowe podsumowanie
    Write-Host "üìã Basic Analysis:" -ForegroundColor Yellow
    python analysis_viewer.py overview

    Write-Host "`nüÜö Provider Comparison:" -ForegroundColor Yellow
    python analysis_viewer.py compare

    Write-Host "`nüó∫Ô∏è Location Analysis:" -ForegroundColor Yellow
    python analysis_viewer.py locations

    # Eksport wynik√≥w
    Write-Host "`nüíæ Exporting Results:" -ForegroundColor Yellow
    python analysis_viewer.py export --export-file "random_locations_summary.csv"

    # Zaawansowana analiza bias (je≈õli plik istnieje)
    if (Test-Path "advanced_bias_analysis.py") {
        Write-Host "`nüî¨ Running Advanced Bias Analysis:" -ForegroundColor Yellow
        python advanced_bias_analysis.py
    } else {
        Write-Host "`n‚ö†Ô∏è advanced_bias_analysis.py not found - skipping bias analysis" -ForegroundColor Yellow
    }
} else {
    Write-Host "`n‚ùå No successful analyses - cannot run advanced analysis" -ForegroundColor Red
}

# Zapisz szczeg√≥≈Çy lokalizacji
Write-Host "`nüíæ SAVING LOCATION DETAILS..." -ForegroundColor Cyan
$locationDetails = @()
for ($i = 0; $i -lt $randomLocations.Count; $i++) {
    $loc = $randomLocations[$i]
    $result = $results[$i]

    $locationDetails += [PSCustomObject]@{
        Index = $i + 1
        Name = $loc.Name
        Latitude = $loc.Lat
        Longitude = $loc.Lon
        Region = $loc.Region
        Status = $result.Status
        Success = $result.Status -eq "Success"
    }
}

$locationDetails | Export-Csv "random_locations_details.csv" -NoTypeInformation
Write-Host "‚úÖ Location details saved: random_locations_details.csv" -ForegroundColor Green

# Final summary
Write-Host "`nüéØ FINAL SUMMARY:" -ForegroundColor Green
Write-Host "===============" -ForegroundColor Green
Write-Host "üìç Random locations tested: $($randomLocations.Count)" -ForegroundColor White
Write-Host "‚úÖ Successful analyses: $successful" -ForegroundColor Green
Write-Host "üåç Regions covered: $($regionCounts.Count)" -ForegroundColor Cyan
Write-Host "üìä Success rate: $successRate%" -ForegroundColor Yellow

Write-Host "`nüìÅ Generated files:" -ForegroundColor Cyan
Write-Host "  üìÑ central_weather_results.csv (main results)" -ForegroundColor White
Write-Host "  üìÑ random_locations_details.csv (location info)" -ForegroundColor White
Write-Host "  üìÑ random_locations_summary.csv (analysis summary)" -ForegroundColor White
Write-Host "  üìÅ dashboard/ (charts and reports)" -ForegroundColor White

Write-Host "`nüöÄ Next steps:" -ForegroundColor Green
Write-Host "  üìä Review dashboard/bias_analysis.png" -ForegroundColor White
Write-Host "  üìã Read dashboard/comprehensive_weather_report.md" -ForegroundColor White
Write-Host "  üìÅ Analyze patterns in random_locations_summary.csv" -ForegroundColor White